<html lang="en">
<head>
    <!-- ========== Meta Tags ========== -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <!-- ========== Title ========== -->
    <title> Risultati</title>
    <!-- ========== Favicon Ico ========== -->
    <!--<link rel="icon" href="fav.ico">-->
    <!-- ========== STYLESHEETS ========== -->
    <!-- Bootstrap CSS -->
    <link href="assets/css/bootstrap.min.css" rel="stylesheet">
    <!-- Fonts Icon CSS -->
    <link href="assets/css/font-awesome.min.css" rel="stylesheet">
    <link href="assets/css/et-line.css" rel="stylesheet">
    <link href="assets/css/ionicons.min.css" rel="stylesheet">
    <!-- Carousel CSS -->
    <link href="assets/css/owl.carousel.min.css" rel="stylesheet">
    <link href="assets/css/owl.theme.default.min.css" rel="stylesheet">
    <!-- Animate CSS -->
    <link rel="stylesheet" href="assets/css/animate.min.css">
    <!-- Custom styles for this template -->
    <link href="assets/css/main.css" rel="stylesheet">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.0/themes/smoothness/jquery-ui.css">
    <link href="assets/css/spinner.css" rel="stylesheet">


</head>

  <body>
    <section style="padding-left:50px; padding-right:50px;">
        <!-- <div class="container"  id="main-container" style="color:black;"> -->
          <table class="table" style="color:black;">
          <tbody>
          <tr><th scope="row ">Numero di test effettuati:</th><td id="n1">0</td></tr>
          <tr><th scope="row ">Numero di test effettuati con Myrror:</th><td id="n2">0</td></tr>
          <tr><th scope="row ">Numero di test effettuati con inserimento manuale:</th><td id="n3">0</td></tr>
          </tbody></table>
          <br><br>

          <table class="table" style="color:black;">
            <thead>
              <tr>
                <th scope="col">#</th>
                <th scope="col">All</th>
                <th scope="col">Myrror</th>
                <th scope="col">Manual</th>
              </tr>
            </thead>
          <tbody>
          <tr><th scope="row ">Lista preferita per interesse:</th><td id="l_int_all">0</td><td id="l_int_myrror">0</td><td id="l_int_manual">0</td></tr>
          <tr><th scope="row ">Lista preferita per personalità:</th><td id="l_pers_all">0</td><td id="l_pers_myrror">0</td><td id="l_pers_manual">0</td></tr>
          </tbody></table>
          <br><br>

          <!-- <div class="row">
            <div id="piechart1" style="width: 550px; height: 350px;"></div>
            <div id="piechart2" style="width: 550px; height: 350px;"></div>
          </div>
          <div class="row">
            <div id="piechart3" style="width: 550px; height: 350px;"></div>
            <div id="piechart4" style="width: 550px; height: 350px;"></div>
            <div id="piechart5" style="width: 550px; height: 350px;"></div>
          </div> -->

          <div class="row" style="margin:0 !important;">
            <div id="piechart6" class="col-md-4" style="width: 100%; min-height: 450px;"></div>
            <div id="piechart7" class="col-md-4" style="width: 100%; min-height: 450px;"></div>
            <div id="piechart8" class="col-md-4" style="width: 100%; min-height: 450px;"></div>
          </div>
          <div class="row" style="margin:0 !important;">
            <div id="piechart9" class="col-md-4" style="width: 100%; min-height: 450px;"></div>
            <div id="piechart10" class="col-md-4" style="width: 100%; min-height: 450px;"></div>
            <div id="piechart11" class="col-md-4" style="width: 100%; min-height: 450px;"></div>
          </div>

          <div class="row" style="margin:0 !important;">
            <div id="piechart1" class="col-md-6" style="width: 100%; min-height: 450px;"></div>
            <div id="piechart2" class="col-md-6" style="width: 100%; min-height: 450px;"></div>
          </div>
          <div class="row" style="margin:0 !important;">
            <div id="piechart3" class="col-md-4" style="width: 100%; min-height: 450px;"></div>
            <div id="piechart4" class="col-md-4" style="width: 100%; min-height: 450px;"></div>
            <div id="piechart5" class="col-md-4" style="width: 100%; min-height: 450px;"></div>
          </div>

        <!--  <table class="table" style="color:black;">
            <thead>
              <tr>
                <th scope="col">Domande test Myrror</th>
                <th scope="col">Media risposte</th>
              </tr>
            </thead>
          <tbody>
          <tr><th scope="row ">Selezione degli interessi:</th><td id="myrror_interessi">0</td></tr>
          <tr><th scope="row ">Stato emotivo da Myrror:</th><td id="myrror_statoEmotivo">0</td></tr>
          </tbody></table>
          <br><br>

          <table class="table" style="color:black;">
            <thead>
              <tr>
                <th scope="col">Domande test Manuale</th>
                <th scope="col">Media risposte</th>
              </tr>
            </thead>
          <tbody>
          <tr><th scope="row ">Selezione della personalita:</th><td id="manuale_personalita">0</td></tr>
          <tr><th scope="row ">Inserimento degli interessi:</th><td id="manuale_interessi">0</td></tr>
          <tr><th scope="row ">Selezione dei luoghi:</th><td id="manuale_luoghi">0</td></tr>
          </tbody></table>
          <br><br> -->

          <table class="table" style="color:black;" id="stats-table">
            <thead>
              <tr>
                <th scope="col">Precision@K</th>
                <th scope="col">All</th>
                <th scope="col">Myrror</th>
                <th scope="col">Manual</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <th scope="row">Precision@5 (LightFM)</th>
                <td id="p11">0</td>
                <td id="p12">0</td>
                <td id="p13">0</td>
              </tr>
              <tr>
                <th scope="row">Precision@5 (Rule-based)</th>
                <td id="p21">0</td>
                <td id="p22">0</td>
                <td id="p23">0</td>
              </tr>
              <tr>
                <th scope="row">Precision@5 (Popularity)</th>
                <td id="p31">0</td>
                <td id="p32">0</td>
                <td id="p33">0</td>
              </tr>
            </tbody>
          </table>
          <br><br>
          <h5 class = "row">Commenti degli utenti:</h5>
          <div id="note"></div>
</section>

      <!-- jquery -->
      <script src="assets/js/jquery.min.js"></script>
      <!-- bootstrap -->
      <script src="assets/js/popper.js"></script>
      <script src="assets/js/bootstrap.min.js"></script>
      <script src="assets/js/waypoints.min.js"></script>
      <!--slick carousel -->
      <script src="assets/js/owl.carousel.min.js"></script>
      <!--parallax -->
      <script src="assets/js/parallax.min.js"></script>
      <!--Counter up -->
      <script src="assets/js/jquery.counterup.min.js"></script>
      <!--Counter down -->
      <script src="assets/js/jquery.countdown.min.js"></script>
      <!-- WOW JS -->
      <script src="assets/js/wow.min.js"></script>
      <!-- Custom js -->
      <script src="assets/js/custom/main.js"></script>

      <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
      <script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/twbs-pagination/1.4.2/jquery.twbsPagination.js"></script>

      <!-- Date picker -->
      <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
      <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

      <!-- Custom js - Functions and constants -->
      <script src="assets/js/custom/constants.js"></script>
      <script src="assets/js/custom/utils.js"></script>

      <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

      <script>

      Object.defineProperties(Array.prototype, {
          count: {
              value: function(query) {
                  /*
                     Counts number of occurrences of query in array, an integer >= 0
                     Uses the javascript == notion of equality.
                  */
                  var count = 0;
                  for(let i=0; i<this.length; i++)
                      if (this[i]==query)
                          count++;
                  return count;
              }
          }
      });

      $.ajax({
          type: 'get',
          url: DJANGO_API_ADDR+'getDatiSperimentazione/',
          success: function (response) {
            //$("#main-container").html(JSON.stringify(tests));

            tests = [];
            for (var i = 0; i < response.length; i++){
              if(response[i].test_completato == true)
                tests.push(response[i]);
            }

            numAll = 0;
            numMyr = 0;
            numMan = 0;

            //lista indice 1 = lightfm, 2 = rule-based, 3 = popularity
            listaIntMyr = {LightFM:0, Rulebased:0, Popularity:0};
            listaPerMyr = {LightFM:0, Rulebased:0, Popularity:0};
            listaIntMan = {LightFM:0, Rulebased:0, Popularity:0};
            listaPerMan = {LightFM:0, Rulebased:0, Popularity:0};

            myrror_interessi = [];
            myrror_statoEmotivo = [];
            manuale_personalita = [];
            manuale_interessi = [];
            manuale_luoghi = [];

            for (var i = 0; i < tests.length; i++){
              var x = tests[i];

              numAll++;
              if (x.schema == "myrror"){
                 numMyr++;
                 if (x.lista_preferita_interesse == "L") listaIntMyr.LightFM++;
                 else if (x.lista_preferita_interesse == "R") listaIntMyr.Rulebased++;
                 else listaIntMyr.Popularity++;

                 if (x.lista_preferita_personalita == "L") listaPerMyr.LightFM++;
                 else if (x.lista_preferita_personalita == "R") listaPerMyr.Rulebased++;
                 else listaPerMyr.Popularity++;

                 if(x.myrror_interessi != 0 && x.myrror_statoEmotivo != 0){
                   myrror_interessi.push(x.myrror_interessi);
                   myrror_statoEmotivo.push(x.myrror_statoEmotivo);
                 }

              }
              else{
                 numMan++;
                 if (x.lista_preferita_interesse == "L") listaIntMan.LightFM++;
                 else if (x.lista_preferita_interesse == "R") listaIntMan.Rulebased++;
                 else listaIntMan.Popularity++;

                 if (x.lista_preferita_personalita == "L") listaPerMan.LightFM++;
                 else if (x.lista_preferita_personalita == "R") listaPerMan.Rulebased++;
                 else listaPerMan.Popularity++;

                 if(x.manuale_personalita != 0 && x.manuale_interessi != 0 && x.manuale_luoghi != 0){
                   manuale_personalita.push(x.manuale_personalita);
                   manuale_interessi.push(x.manuale_interessi);
                   manuale_luoghi.push(x.manuale_luoghi);
                 }
              }

            }

            listaIntALL = {LightFM:listaIntMyr.LightFM+listaIntMan.LightFM, Rulebased:listaIntMyr.Rulebased+listaIntMan.Rulebased, Popularity:listaIntMyr.Popularity+listaIntMan.Popularity};
            listaPerALL = {LightFM:listaPerMyr.LightFM+listaPerMan.LightFM, Rulebased:listaPerMyr.Rulebased+listaPerMan.Rulebased, Popularity:listaPerMyr.Popularity+listaPerMan.Popularity};



            $("#n1").html(numAll);
            $("#n2").html(numMyr);
            $("#n3").html(numMan);

            var obj = listaIntALL;
            var key = Object.keys(obj).reduce(function(a, b){ return obj[a] > obj[b] ? a : b})
            var val = Math.round(obj[key]*100/numAll);
            $("#l_int_all").html(key + " ("+val+"%)");

            var obj = listaPerALL;
            var key = Object.keys(obj).reduce(function(a, b){ return obj[a] > obj[b] ? a : b})
            var val = Math.round(obj[key]*100/numAll);
            $("#l_pers_all").html(key + " ("+val+"%)");

            var obj = listaIntMyr;
            var key = Object.keys(obj).reduce(function(a, b){ return obj[a] > obj[b] ? a : b})
            var val = Math.round(obj[key]*100/numMyr);
            $("#l_int_myrror").html(key + " ("+val+"%)");

            var obj = listaPerMyr;
            var key = Object.keys(obj).reduce(function(a, b){ return obj[a] > obj[b] ? a : b})
            var val = Math.round(obj[key]*100/numMyr);
            $("#l_pers_myrror").html(key + " ("+val+"%)");

            var obj = listaIntMan;
            var key = Object.keys(obj).reduce(function(a, b){ return obj[a] > obj[b] ? a : b})
            var val = Math.round(obj[key]*100/numMan);
            $("#l_int_manual").html(key + " ("+val+"%)");

            var obj = listaPerMan;
            var key = Object.keys(obj).reduce(function(a, b){ return obj[a] > obj[b] ? a : b})
            var val = Math.round(obj[key]*100/numMan);
            $("#l_pers_manual").html(key + " ("+val+"%)");


            P_MyrLight = 0;
            P_MyrRule = 0;
            P_MyrPop = 0;
            P_ManLight = 0;
            P_ManRule = 0;
            P_ManPop = 0;
            for (var i = 0; i < tests.length; i++){
              var x = tests[i];
              if (x.schema == "myrror"){
                var PrecLight = 0;
                var PrecRule = 0;
                var PrecPop = 0;
                for(var z = 1; z <=5; z++){
                  if(x["l"+z] == true)
                    PrecLight++;
                  if(x["r"+z] == true)
                    PrecRule++;
                  if(x["p"+z] == true)
                    PrecPop++;
                }
                PrecLight = PrecLight/5;
                PrecRule = PrecRule/5;
                PrecPop = PrecPop/5;
                P_MyrLight = P_MyrLight + PrecLight;
                P_MyrRule = P_MyrRule + PrecRule;
                P_MyrPop = P_MyrPop + PrecPop;
              }

              else{
                var PrecLight = 0;
                var PrecRule = 0;
                var PrecPop = 0;
                for(var z = 1; z <=5; z++){
                  if(x["l"+z] == true)
                    PrecLight++;
                  if(x["r"+z] == true)
                    PrecRule++;
                  if(x["p"+z] == true)
                    PrecPop++;
                }
                PrecLight = PrecLight/5;
                PrecRule = PrecRule/5;
                PrecPop = PrecPop/5;
                P_ManLight = P_ManLight + PrecLight;
                P_ManRule = P_ManRule + PrecRule;
                P_ManPop = P_ManPop + PrecPop;
              }
            }

            $("#p11").html(((P_MyrLight + P_ManLight)/numAll).toFixed(2));
            $("#p12").html((P_MyrLight/numMyr).toFixed(2));
            $("#p13").html((P_ManLight/numMan).toFixed(2));
            $("#p21").html(((P_MyrRule + P_ManRule)/numAll).toFixed(2));
            $("#p22").html((P_MyrRule/numMyr).toFixed(2));
            $("#p23").html((P_ManRule/numMan).toFixed(2));
            $("#p31").html(((P_MyrPop + P_ManPop)/numAll).toFixed(2));
            $("#p32").html((P_MyrPop/numMyr).toFixed(2));
            $("#p33").html((P_ManPop/numMan).toFixed(2));

            for (var i = 0; i < tests.length; i++){
              var x = tests[i];
              if (x.note != "")
                $("#note").append("<div class='row'><b>>User test " + x.schema + ": &nbsp;</b>" + x.note + "</div>");
            }


            google.charts.load('current', {'packages':['corechart']});
            google.charts.setOnLoadCallback(drawChart);

            //xz = [1,1,3,2,3,3,3,2,3,5,4,4];
            function drawChart() {
              drawCustomChart('piechart1', 'Myrror: Domanda sugli interessi selezionati', myrror_interessi);
              drawCustomChart('piechart2', 'Myrror: Domanda sullo stato emotivo selezionato', myrror_statoEmotivo);
              drawCustomChart('piechart3', 'Manuale: Domanda sulla selezione della personalità', manuale_personalita);
              drawCustomChart('piechart4', 'Manuale: Domanda sull\'inserimento degli interessi', manuale_interessi);
              drawCustomChart('piechart5', 'Manuale: Domanda sulla selezione dei luoghi visitati', manuale_luoghi);

              drawCustomChart2('piechart6', 'Myrror: Algoritmo preferito per interessi', listaIntMyr);
              drawCustomChart2('piechart7', 'Manuale: Algoritmo preferito per interessi', listaIntMan);
              drawCustomChart2('piechart8', 'Totale: Algoritmo preferito per interessi', listaIntALL);

              drawCustomChart2('piechart9', 'Myrror: Algoritmo preferito per personalità', listaPerMyr);
              drawCustomChart2('piechart10', 'Manuale: Algoritmo preferito per personalità', listaPerMan);
              drawCustomChart2('piechart11', 'Totale: Algoritmo preferito per personalità', listaPerALL);
            }


          },
          error: function(e) {
            var je = JSON.parse(e.testsText);
            alert("ko");
          }
      });


      function drawCustomChart(id, titolo, lista){
        var mean = 0;
        if ( lista.length > 0){
          var sum = 0;
          for (var i = 0; i < lista.length; i++)
            sum = sum + lista[i];
          mean = sum/lista.length;
        }

        var data = google.visualization.arrayToDataTable([
          ['Risposta', 'Numero'],
          ['(1) Per nulla', lista.count(1)],
          ['(2) Poco', lista.count(2)],
          ['(3) Abbastanza', lista.count(3)],
          ['(4) Molto', lista.count(4)],
          ['(5) Moltissimo',lista.count(5)]
        ]);
        var options = {
          title: titolo+'\n(Punteggio medio: ' + mean.toFixed(2) +')',
        };
        var chart = new google.visualization.PieChart(document.getElementById(id));
        chart.draw(data, options);
      }



      function drawCustomChart2(id, titolo, lista){
        var data = google.visualization.arrayToDataTable([
          ['Algoritmo', 'Numero'],
          ['LightFM', lista.LightFM],
          ['Rule-based', lista.Rulebased],
          ['Popularity', lista.Popularity]

        ]);
        var options = {
          title: titolo
        };
        var chart = new google.visualization.PieChart(document.getElementById(id));
        chart.draw(data, options);
      }


      </script>
  </body>
</html>
